<!DOCTYPE html>
<html lang="sv">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klassrumsplacering</title>
    <style>
        /* === Design System === */
        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-card: #252540;
            --text-primary: #f0f0f5;
            --text-secondary: #a0a0b0;
            --accent-primary: #6366f1;
            --accent-secondary: #818cf8;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.3);
            --shadow-glow: 0 0 20px rgba(99, 102, 241, 0.3);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="light"] {
            --bg-primary: #f5f5f7;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #1a1a2e;
            --text-secondary: #6b7280;
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        [data-theme="print"] {
            --bg-primary: #ffffff;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #000000;
            --text-secondary: #333333;
            --accent-primary: #333333;
            --border-color: #000000;
            --shadow-soft: none;
            --shadow-glow: none;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: var(--transition);
        }

        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .app-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .app-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            box-shadow: var(--shadow-glow);
        }

        .btn-primary:hover {
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.5);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-warning {
            background: var(--accent-warning);
            color: white;
        }

        .btn-danger {
            background: var(--accent-danger);
            color: white;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        select {
            padding: 0.625rem 1rem;
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
        }

        select:hover {
            border-color: var(--accent-primary);
        }

        .main-content {
            display: flex;
            flex: 1;
            gap: clamp(0.5rem, 1vw, 1.5rem);
            padding: clamp(0.5rem, 1.5vw, 1.5rem);
        }

        .sidebar {
            width: clamp(140px, 14vw, 200px);
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: clamp(0.5rem, 1vw, 1rem);
            border: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .sidebar h3 {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .sidebar-right {
            width: clamp(120px, 12vw, 180px);
        }

        .unplaced-zone {
            min-height: 200px;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            border: 2px dashed var(--border-color);
            transition: var(--transition);
        }

        .unplaced-zone.drag-over {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .classroom-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
        }

        .classroom {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: clamp(0.75rem, 2vw, 2rem);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-soft);
            width: 100%;
            max-width: fit-content;
        }

        .tavla {
            background: linear-gradient(135deg, #374151, #4b5563);
            color: white;
            text-align: center;
            padding: 0.6rem 2rem;
            border-radius: var(--radius-sm);
            margin: 0 auto 1rem;
            font-weight: 600;
            font-size: 0.85rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            max-width: 250px;
        }

        [data-theme="print"] .tavla {
            background: white;
            color: black;
            border: 2px solid black;
        }

        .seating-grid {
            display: grid;
            gap: clamp(0.35rem, 0.6vw, 0.75rem);
        }

        .seat {
            width: clamp(90px, 10vw, 150px);
            height: clamp(48px, 5vw, 68px);
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
        }

        .seat:hover {
            border-color: var(--accent-primary);
            transform: scale(1.02);
        }

        .seat.drag-over {
            border-color: var(--accent-success);
            background: rgba(16, 185, 129, 0.1);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
        }

        .seat.empty {
            background: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(255, 255, 255, 0.02) 5px, rgba(255, 255, 255, 0.02) 10px);
            border-style: dashed;
        }

        [data-theme="print"] .seat {
            border: 1px solid black;
            background: white;
        }

        [data-theme="print"] .seat.empty {
            background: white;
            border-style: dashed;
        }

        .seat.removed {
            background: transparent;
            border: 2px dashed rgba(255, 255, 255, 0.1);
            opacity: 0.3;
            cursor: pointer;
        }

        .seat.removed:hover {
            opacity: 0.6;
            border-color: var(--accent-primary);
        }

        [data-theme="light"] .seat.removed {
            border-color: rgba(0, 0, 0, 0.1);
        }

        [data-theme="print"] .seat.removed {
            visibility: hidden;
        }

        .student {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: grab;
            transition: var(--transition);
            user-select: none;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            max-width: 100%;
        }

        .student:hover {
            background: var(--accent-primary);
            color: white;
            transform: scale(1.05);
            box-shadow: var(--shadow-glow);
        }

        .student.dragging {
            opacity: 0.5;
            transform: scale(1.1);
        }

        .seat .student {
            position: absolute;
            width: calc(100% - 8px);
            height: calc(100% - 8px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        [data-theme="print"] .student {
            background: white;
            border: 1px solid black;
            color: black;
        }

        .settings {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .settings label {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .settings input[type="number"] {
            padding: 0.5rem;
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            width: 100%;
        }

        .theme-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .theme-btn {
            padding: 0.5rem;
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.75rem;
            transition: var(--transition);
        }

        .theme-btn:hover {
            border-color: var(--accent-primary);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: var(--radius-lg);
            max-width: 400px;
            width: 90%;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-soft);
        }

        .modal-content h2 {
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
        }

        .modal-content input[type="text"] {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .modal-close {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--accent-danger);
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
        }

        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
            }

            .unplaced-zone {
                flex-direction: row;
                flex-wrap: wrap;
                min-height: auto;
            }
        }

        @media print {

            .app-header,
            .sidebar {
                display: none !important;
            }

            .classroom-wrapper {
                padding: 0;
            }

            .classroom {
                box-shadow: none;
                border: none;
            }
        }

        /* Fullscreen mode styling */
        .classroom:fullscreen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--bg-primary);
            padding: 2rem;
            width: 100vw;
            height: 100vh;
            overflow: auto;
        }

        .classroom:fullscreen .tavla {
            font-size: 1.5rem;
            padding: 1.5rem 4rem;
            max-width: 400px;
            margin-bottom: 2rem;
            flex-shrink: 0;
        }

        .classroom:fullscreen .seating-grid {
            gap: 1rem;
            grid-template-columns: repeat(5, 160px) !important;
        }

        .classroom:fullscreen .seat {
            width: 160px;
            height: 80px;
        }

        .classroom:fullscreen .student {
            font-size: 1.1rem;
            font-weight: 600;
            padding: 0.75rem 1.25rem;
        }

        /* === B√§nkv√§ljare Overlay === */
        .bankval-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 20, 0.95);
            backdrop-filter: blur(12px);
            z-index: 900;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .bankval-overlay.active {
            display: flex;
        }

        .bankval-header {
            width: 100%;
            max-width: 1100px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .bankval-header h2 {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #6366f1, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .bankval-close {
            background: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #94a3b8;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .bankval-close:hover {
            color: #ef4444;
            border-color: #ef4444;
        }

        .bankval-body {
            width: 100%;
            max-width: 1100px;
            display: grid;
            grid-template-columns: 240px 1fr;
            gap: 1.5rem;
            flex: 1;
        }

        @media (max-width: 800px) {
            .bankval-body {
                grid-template-columns: 1fr;
            }
        }

        .bankval-controls {
            background: rgba(30, 30, 50, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            height: fit-content;
        }

        .bankval-display-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .bankval-result {
            background: rgba(30, 30, 50, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .bankval-result::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, #6366f1, #a855f7);
        }

        .bankval-result-label {
            font-size: 0.85rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        .bankval-result-name {
            font-size: clamp(2.5rem, 8vw, 4.5rem);
            font-weight: 900;
            background: linear-gradient(135deg, #6366f1, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.1;
            transition: all 0.3s ease;
            min-height: 1.2em;
        }

        .bankval-result-name.spinning {
            animation: bvSpin 0.12s ease-in-out;
        }

        @keyframes bvSpin {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.08);
                opacity: 0.7;
            }
        }

        .bankval-result-name.golden {
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #d97706);
            -webkit-background-clip: text;
            background-clip: text;
        }

        .bankval-random-btn {
            width: 100%;
            padding: 1rem;
            font-size: 1.2rem;
            font-weight: 700;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #6366f1, #a855f7);
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
            transition: all 0.2s;
        }

        .bankval-random-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(99, 102, 241, 0.5);
        }

        .bankval-random-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .bankval-random-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .bankval-grid-wrapper {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 16px;
            padding: 2rem 1rem 1rem;
            position: relative;
            overflow: auto;
            display: flex;
            justify-content: center;
        }

        .bankval-grid-wrapper::before {
            content: 'üì∫ TAVLA';
            position: absolute;
            top: 0.5rem;
            left: 50%;
            transform: translateX(-50%);
            background: #6366f1;
            color: white;
            padding: 0.2rem 1rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .bankval-grid {
            display: grid;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .bv-seat {
            width: 110px;
            height: 55px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 8px;
            transition: all 0.2s ease;
            cursor: default;
            position: relative;
        }

        .bv-seat .bv-name {
            font-size: 0.8rem;
            font-weight: 600;
            color: #f0f0f5;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100px;
        }

        .bv-seat .bv-stars {
            font-size: 0.55rem;
            color: #fbbf24;
            margin-top: 1px;
        }

        .bv-seat.empty {
            background: transparent;
            border: 2px dashed rgba(255, 255, 255, 0.08);
            opacity: 0.3;
        }

        .bv-seat.removed {
            background: transparent;
            border: 2px dashed rgba(255, 255, 255, 0.05);
            opacity: 0.15;
        }

        .bv-seat.selected {
            background: rgba(250, 204, 21, 0.45);
            border-color: #facc15;
            box-shadow: 0 0 20px rgba(250, 204, 21, 0.6);
            animation: bvSelectedPulse 1.2s ease-in-out infinite;
        }

        @keyframes bvSelectedPulse {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(250, 204, 21, 0.5);
                background: rgba(250, 204, 21, 0.35);
            }

            50% {
                box-shadow: 0 0 30px rgba(250, 204, 21, 0.8), 0 0 50px rgba(250, 204, 21, 0.3);
                background: rgba(250, 204, 21, 0.55);
            }
        }

        @keyframes bvPulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.12);
            }

            100% {
                transform: scale(1);
            }
        }

        .bv-seat.maxed {
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #d97706);
            border-color: #f59e0b;
        }

        .bv-seat.maxed .bv-name {
            color: #000;
        }

        .bv-seat.maxed .bv-stars {
            color: #000;
        }

        .bv-seat.spinning-preview {
            background: rgba(250, 204, 21, 0.55);
            border-color: #facc15;
            box-shadow: 0 0 18px rgba(250, 204, 21, 0.6);
        }

        .bv-section-label {
            font-size: 0.75rem;
            color: #94a3b8;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .bv-mode-selector {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .bv-mode-btn {
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 8px;
            color: #94a3b8;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .bv-mode-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #f0f0f5;
        }

        .bv-mode-btn.active {
            background: rgba(99, 102, 241, 0.15);
            border-color: #6366f1;
            color: #818cf8;
        }

        .bv-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .bv-input-group input {
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #f0f0f5;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
        }

        .bv-input-group input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .bv-stats {
            display: flex;
            justify-content: space-around;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }

        .bv-stat {
            text-align: center;
        }

        .bv-stat-value {
            font-size: 1.15rem;
            font-weight: 700;
            color: #6366f1;
        }

        .bv-stat-label {
            font-size: 0.6rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .bv-reset-btn {
            width: 100%;
            padding: 0.5rem;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            color: #ef4444;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bv-reset-btn:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        .bv-info {
            background: rgba(99, 102, 241, 0.08);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 8px;
            padding: 0.6rem;
            font-size: 0.7rem;
            color: #94a3b8;
            line-height: 1.5;
        }

        .bv-info strong {
            color: #818cf8;
        }

        .bankval-toast {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(30, 30, 50, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            color: #f0f0f5;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            transition: transform 0.3s ease;
            z-index: 1100;
        }

        .bankval-toast.show {
            transform: translateX(-50%) translateY(0);
        }

        #bankvalToggle.active {
            background: linear-gradient(135deg, #6366f1, #a855f7);
            color: white;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.4);
        }

        /* VEP #4: Ing√•ngsanimation f√∂r valt namn */
        .bankval-result-name.reveal {
            animation: bvReveal 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes bvReveal {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }

            60% {
                transform: scale(1.1);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* VEP #2: Hj√§lptext */
        .bankval-result-name.hint {
            font-size: 1.1rem;
            font-weight: 500;
            -webkit-text-fill-color: #64748b;
        }

        /* VEP #7: Pulsanimation p√• idle-knapp */
        .bankval-random-btn:not(:disabled) {
            animation: bvBtnPulse 2s ease-in-out infinite;
        }

        @keyframes bvBtnPulse {

            0%,
            100% {
                box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
            }

            50% {
                box-shadow: 0 4px 30px rgba(99, 102, 241, 0.7), 0 0 40px rgba(168, 85, 247, 0.3);
            }
        }

        .bankval-random-btn:disabled {
            animation: none;
        }

        /* VEP #5: Historik */
        .bv-history {
            width: 100%;
            margin-top: 0.5rem;
        }

        .bv-history-label {
            font-size: 0.7rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.3rem;
        }

        .bv-history-list {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }

        .bv-history-item {
            padding: 0.25rem 0.6rem;
            background: rgba(99, 102, 241, 0.12);
            border: 1px solid rgba(99, 102, 241, 0.25);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #a5b4fc;
        }

        .bv-history-item:first-child {
            background: rgba(99, 102, 241, 0.25);
            border-color: #6366f1;
            color: #c7d2fe;
        }

        /* VEP #6: √Öngra-knapp */
        .bv-undo-btn {
            padding: 0.4rem 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #94a3b8;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bv-undo-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #f0f0f5;
        }

        .bv-undo-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* VEP #9: Konfetti */
        .bv-confetti {
            position: fixed;
            pointer-events: none;
            z-index: 1050;
            width: 10px;
            height: 10px;
            border-radius: 2px;
            animation: bvConfettiFall 1.2s ease-out forwards;
        }

        @keyframes bvConfettiFall {
            0% {
                transform: translateY(0) rotate(0deg) scale(1);
                opacity: 1;
            }

            100% {
                transform: translateY(200px) rotate(720deg) scale(0.3);
                opacity: 0;
            }
        }

        /* VEP #1: Klassnamn i header */
        .bankval-class-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: #a5b4fc;
            background: rgba(99, 102, 241, 0.15);
            padding: 0.25rem 0.8rem;
            border-radius: 8px;
            margin-left: 0.75rem;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header class="app-header">
            <h1>ü™ë Klassrumsplacering</h1>
            <div class="controls">
                <select id="classSelect">
                    <option value="klass1">BJKA1-25</option>
                    <option value="klass2">BJKD1-25</option>
                    <option value="klass3">BJKE1-25</option>
                </select>
                <button id="exportBtn" class="btn btn-primary">
                    <span class="icon">üì∑</span> Exportera PNG
                </button>
                <button id="addStudentBtn" class="btn btn-secondary">
                    <span class="icon">‚ûï</span> L√§gg till elev
                </button>
                <button id="resetBtn" class="btn btn-warning">
                    <span class="icon">üîÑ</span> √Öterst√§ll
                </button>
                <button id="clearDesksBtn" class="btn btn-secondary">
                    <span class="icon">üßπ</span> T√∂m b√§nkar
                </button>
                <button id="fullscreenBtn" class="btn btn-secondary">
                    <span class="icon">üñ•Ô∏è</span> Helsk√§rm
                </button>
                <button id="bankvalToggle" class="btn btn-secondary">
                    <span class="icon">üéØ</span> B√§nkv√§ljare
                </button>
            </div>
        </header>

        <main class="main-content">
            <div class="sidebar">
                <h3>üìã Ej placerade</h3>
                <div id="unplacedStudents" class="unplaced-zone"></div>
            </div>

            <div class="classroom-wrapper">
                <div id="classroom" class="classroom">
                    <div class="tavla">Tavla</div>
                    <div id="seatingGrid" class="seating-grid"></div>
                </div>
            </div>

            <div class="sidebar sidebar-right">
                <h3>‚öôÔ∏è Inst√§llningar</h3>
                <div class="settings">
                    <label>
                        Rader:
                        <input type="number" id="rowCount" value="5" min="1" max="10">
                    </label>
                    <label>
                        Kolumner:
                        <input type="number" id="colCount" value="5" min="1" max="8">
                    </label>
                    <button id="applyGridBtn" class="btn btn-small">Applicera</button>
                </div>
                <h3 style="margin-top: 1.5rem;">üé® Tema</h3>
                <div class="theme-buttons">
                    <button class="theme-btn" data-theme="light">‚òÄÔ∏è Ljust</button>
                    <button class="theme-btn" data-theme="dark">üåô M√∂rkt</button>
                    <button class="theme-btn" data-theme="print">üñ®Ô∏è Print</button>
                </div>
            </div>
        </main>
    </div>

    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>L√§gg till elev</h2>
            <input type="text" id="newStudentName" placeholder="Elevens namn">
            <button id="confirmAddStudent" class="btn btn-primary">L√§gg till</button>
        </div>
    </div>

    <div id="editStudentModal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>Redigera elev</h2>
            <input type="text" id="editStudentName" placeholder="Elevens namn">
            <div class="modal-actions">
                <button id="confirmEditStudent" class="btn btn-primary">Spara</button>
                <button id="deleteStudent" class="btn btn-danger">Ta bort</button>
            </div>
        </div>
    </div>

    <!-- B√§nkv√§ljare Overlay -->
    <div id="bankvalOverlay" class="bankval-overlay">
        <div class="bankval-header">
            <h2>üéØ B√§nkv√§ljare <span class="bankval-class-name" id="bankvalClassName"></span></h2>
            <button id="bankvalClose" class="bankval-close">‚úï</button>
        </div>
        <div class="bankval-body">
            <div class="bankval-controls">
                <div class="bv-section-label">Urvalsmetod</div>
                <div class="bv-mode-selector">
                    <button class="bv-mode-btn active" data-mode="fair">‚öñÔ∏è R√§ttvis</button>
                    <button class="bv-mode-btn" data-mode="weighted">üìä Viktad</button>
                    <button class="bv-mode-btn" data-mode="random">üé≤ Slump</button>
                </div>

                <div class="bv-input-group">
                    <span class="bv-section-label">Max stj√§rnor per elev</span>
                    <input type="number" id="bankvalMaxStars" value="3" min="1" max="10">
                </div>

                <div class="bv-stats">
                    <div class="bv-stat">
                        <div class="bv-stat-value" id="bvStatAvailable">0</div>
                        <div class="bv-stat-label">Tillg√§ngliga</div>
                    </div>
                    <div class="bv-stat">
                        <div class="bv-stat-value" id="bvStatMaxed">0</div>
                        <div class="bv-stat-label">Maximerade</div>
                    </div>
                    <div class="bv-stat">
                        <div class="bv-stat-value" id="bvStatTotal">0</div>
                        <div class="bv-stat-label">Totalt</div>
                    </div>
                </div>

                <button class="bv-undo-btn" id="bankvalUndo" disabled>‚ü≤ √Öngra senaste</button>
                <button class="bv-reset-btn" id="bankvalResetStars">‚Üª Nollst√§ll stj√§rnor</button>

                <div class="bv-info">
                    <strong>‚öñÔ∏è R√§ttvis:</strong> Minst valda f√∂rst<br>
                    <strong>üìä Viktad:</strong> H√∂gre chans f√∂r f√§rre stj√§rnor<br>
                    <strong>üé≤ Slump:</strong> Helt slumpm√§ssigt<br>
                    <strong>Mellanslag</strong> = slumpa
                </div>
            </div>

            <div class="bankval-display-area">
                <div class="bankval-result">
                    <div class="bankval-result-label">Vald elev</div>
                    <div class="bankval-result-name hint" id="bankvalDisplay" aria-live="polite">Tryck mellanslag eller
                        klicka nedan ‚¨á</div>
                </div>
                <button class="bankval-random-btn" id="bankvalRandomBtn">üéØ Slumpa elev</button>
                <div class="bv-history" id="bankvalHistory" style="display:none">
                    <div class="bv-history-label">Senaste valda</div>
                    <div class="bv-history-list" id="bankvalHistoryList"></div>
                </div>
                <div class="bankval-grid-wrapper">
                    <div class="bankval-grid" id="bankvalGrid"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="bankval-toast" id="bankvalToast"></div>

    <script>
        const classData = {
            klass1: {
                name: "BJKA1-25",
                rows: 5,
                cols: 5,
                students: [
                    ["Atena", "Emil", "Asiya", "Emran", "Emin"],
                    ["Anastasia", "Haydar", "Sham", "Lilo", "Vilte"],
                    ["Sahar", "Edwin", "Bisan", "Viktor", "Zouha"],
                    ["Asef", "Aoys", "Amanda", "Agnes", "Bonnie"],
                    ["Emilio", "Luna", "", "", "Lea"]
                ]
            },
            klass2: {
                name: "BJKD1-25",
                rows: 5,
                cols: 5,
                students: [
                    ["Adelie", "Louise", "Anabelle", "Alice", "Saga"],
                    ["Millie", "Linn√©a", "Mousa", "Ziyad", "Youssef"],
                    ["Ahmed", "Wille", "Ahmad", "Zaga", "Lowa"],
                    ["Bao", "Casper", "", "Sixten", "Vincent"],
                    ["Semran", "", "", "Tilda", "Rayan"]
                ]
            },
            klass3: {
                name: "BJKE1-25",
                rows: 5,
                cols: 5,
                students: [
                    ["Amina", "Lorik", "Alia", "Jaxz", "Raul"],
                    ["Elisei", "Hugo", "Bastian", "Hugo", "Izabelle"],
                    ["Ibrahim", "Miral", "Elin", "Thea", "Hazem"],
                    ["Ruth", "Lian", "Dijana", "Abel", "Jack"],
                    ["Elin", "", "", "Fideli", "Nelia"]
                ]
            }
        };

        let currentClass = 'klass1';
        let currentLayout = null;
        let draggedStudent = null;
        let draggedFrom = null;

        const classSelect = document.getElementById('classSelect');
        const seatingGrid = document.getElementById('seatingGrid');
        const unplacedStudents = document.getElementById('unplacedStudents');
        const rowCountInput = document.getElementById('rowCount');
        const colCountInput = document.getElementById('colCount');
        const exportBtn = document.getElementById('exportBtn');
        const addStudentBtn = document.getElementById('addStudentBtn');
        const resetBtn = document.getElementById('resetBtn');
        const clearDesksBtn = document.getElementById('clearDesksBtn');
        const applyGridBtn = document.getElementById('applyGridBtn');
        const addStudentModal = document.getElementById('addStudentModal');
        const editStudentModal = document.getElementById('editStudentModal');
        const newStudentNameInput = document.getElementById('newStudentName');
        const editStudentNameInput = document.getElementById('editStudentName');
        const confirmAddStudent = document.getElementById('confirmAddStudent');
        const confirmEditStudent = document.getElementById('confirmEditStudent');
        const deleteStudentBtn = document.getElementById('deleteStudent');
        const themeButtons = document.querySelectorAll('.theme-btn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');

        function init() {
            loadClass(currentClass);
            setupEventListeners();
        }

        function loadClass(classKey) {
            currentClass = classKey;
            const data = classData[classKey];
            currentLayout = {
                name: data.name,
                rows: data.rows,
                cols: data.cols,
                grid: data.students.map(row => [...row]),
                unplaced: [],
                removedSeats: []
            };
            const saved = localStorage.getItem(`seating_${classKey}`);
            if (saved) {
                const parsed = JSON.parse(saved);
                currentLayout.grid = parsed.grid;
                currentLayout.unplaced = parsed.unplaced || [];
                currentLayout.rows = parsed.rows || data.rows;
                currentLayout.cols = parsed.cols || data.cols;
                currentLayout.removedSeats = parsed.removedSeats || [];
            }
            rowCountInput.value = currentLayout.rows;
            colCountInput.value = currentLayout.cols;
            renderGrid();
            renderUnplaced();
        }

        function saveLayout() {
            localStorage.setItem(`seating_${currentClass}`, JSON.stringify({
                grid: currentLayout.grid,
                unplaced: currentLayout.unplaced,
                rows: currentLayout.rows,
                cols: currentLayout.cols,
                removedSeats: currentLayout.removedSeats
            }));
        }

        function renderGrid() {
            seatingGrid.innerHTML = '';
            seatingGrid.style.gridTemplateColumns = `repeat(${currentLayout.cols}, clamp(90px, 10vw, 150px))`;
            for (let row = 0; row < currentLayout.rows; row++) {
                for (let col = 0; col < currentLayout.cols; col++) {
                    const seatKey = `${row}-${col}`;
                    const isRemoved = currentLayout.removedSeats.includes(seatKey);
                    const seat = document.createElement('div');
                    seat.className = 'seat';
                    seat.dataset.row = row;
                    seat.dataset.col = col;
                    if (isRemoved) {
                        seat.classList.add('removed');
                        seat.addEventListener('contextmenu', (e) => { e.preventDefault(); toggleSeatRemoved(row, col); });
                        seatingGrid.appendChild(seat);
                        continue;
                    }
                    const studentName = currentLayout.grid[row]?.[col] || '';
                    if (studentName) {
                        const student = createStudentElement(studentName);
                        seat.appendChild(student);
                    } else {
                        seat.classList.add('empty');
                        seat.addEventListener('contextmenu', (e) => { e.preventDefault(); toggleSeatRemoved(row, col); });
                    }
                    seat.addEventListener('dragover', handleDragOver);
                    seat.addEventListener('dragleave', handleDragLeave);
                    seat.addEventListener('drop', handleDrop);
                    seatingGrid.appendChild(seat);
                }
            }
        }

        function toggleSeatRemoved(row, col) {
            const seatKey = `${row}-${col}`;
            const idx = currentLayout.removedSeats.indexOf(seatKey);
            if (idx > -1) currentLayout.removedSeats.splice(idx, 1);
            else currentLayout.removedSeats.push(seatKey);
            saveLayout();
            renderGrid();
        }

        function renderUnplaced() {
            unplacedStudents.innerHTML = '';
            currentLayout.unplaced.forEach(name => {
                const student = createStudentElement(name);
                unplacedStudents.appendChild(student);
            });
        }

        function createStudentElement(name) {
            const student = document.createElement('div');
            student.className = 'student';
            student.textContent = name;
            student.draggable = true;
            student.addEventListener('dragstart', handleDragStart);
            student.addEventListener('dragend', handleDragEnd);
            student.addEventListener('dblclick', () => openEditModal(student));
            return student;
        }

        function handleDragStart(e) {
            draggedStudent = e.target.textContent;
            e.target.classList.add('dragging');
            const seat = e.target.closest('.seat');
            if (seat) draggedFrom = { type: 'seat', row: parseInt(seat.dataset.row), col: parseInt(seat.dataset.col) };
            else draggedFrom = { type: 'unplaced' };
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedStudent = null;
            draggedFrom = null;
        }

        function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            const targetSeat = e.currentTarget;
            const targetRow = parseInt(targetSeat.dataset.row);
            const targetCol = parseInt(targetSeat.dataset.col);
            if (!draggedStudent) return;
            const existingStudent = currentLayout.grid[targetRow]?.[targetCol] || '';
            if (draggedFrom.type === 'seat') {
                currentLayout.grid[draggedFrom.row][draggedFrom.col] = existingStudent;
            } else {
                const idx = currentLayout.unplaced.indexOf(draggedStudent);
                if (idx > -1) currentLayout.unplaced.splice(idx, 1);
                if (existingStudent) currentLayout.unplaced.push(existingStudent);
            }
            while (currentLayout.grid.length <= targetRow) currentLayout.grid.push([]);
            while (currentLayout.grid[targetRow].length <= targetCol) currentLayout.grid[targetRow].push('');
            currentLayout.grid[targetRow][targetCol] = draggedStudent;
            saveLayout();
            renderGrid();
            renderUnplaced();
        }

        unplacedStudents.addEventListener('dragover', (e) => { e.preventDefault(); unplacedStudents.classList.add('drag-over'); });
        unplacedStudents.addEventListener('dragleave', () => { unplacedStudents.classList.remove('drag-over'); });
        unplacedStudents.addEventListener('drop', (e) => {
            e.preventDefault();
            unplacedStudents.classList.remove('drag-over');
            if (!draggedStudent || draggedFrom.type === 'unplaced') return;
            currentLayout.grid[draggedFrom.row][draggedFrom.col] = '';
            currentLayout.unplaced.push(draggedStudent);
            saveLayout();
            renderGrid();
            renderUnplaced();
        });

        let editingStudent = null;
        function openEditModal(studentElement) {
            editingStudent = studentElement;
            editStudentNameInput.value = studentElement.textContent;
            editStudentModal.classList.add('active');
            editStudentNameInput.focus();
        }

        function closeModals() {
            addStudentModal.classList.remove('active');
            editStudentModal.classList.remove('active');
            newStudentNameInput.value = '';
            editStudentNameInput.value = '';
            editingStudent = null;
        }

        document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', closeModals));

        addStudentBtn.addEventListener('click', () => { addStudentModal.classList.add('active'); newStudentNameInput.focus(); });

        confirmAddStudent.addEventListener('click', () => {
            const name = newStudentNameInput.value.trim();
            if (name) { currentLayout.unplaced.push(name); saveLayout(); renderUnplaced(); }
            closeModals();
        });

        newStudentNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') confirmAddStudent.click(); });

        confirmEditStudent.addEventListener('click', () => {
            const newName = editStudentNameInput.value.trim();
            if (!newName || !editingStudent) { closeModals(); return; }
            const oldName = editingStudent.textContent;
            for (let row of currentLayout.grid) {
                for (let i = 0; i < row.length; i++) { if (row[i] === oldName) row[i] = newName; }
            }
            const idx = currentLayout.unplaced.indexOf(oldName);
            if (idx > -1) currentLayout.unplaced[idx] = newName;
            saveLayout();
            renderGrid();
            renderUnplaced();
            closeModals();
        });

        deleteStudentBtn.addEventListener('click', () => {
            if (!editingStudent) { closeModals(); return; }
            const name = editingStudent.textContent;
            for (let row of currentLayout.grid) {
                for (let i = 0; i < row.length; i++) { if (row[i] === name) row[i] = ''; }
            }
            const idx = currentLayout.unplaced.indexOf(name);
            if (idx > -1) currentLayout.unplaced.splice(idx, 1);
            saveLayout();
            renderGrid();
            renderUnplaced();
            closeModals();
        });

        editStudentNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') confirmEditStudent.click(); });

        resetBtn.addEventListener('click', () => {
            if (confirm('Vill du √•terst√§lla till originalplaceringen?')) {
                localStorage.removeItem(`seating_${currentClass}`);
                loadClass(currentClass);
            }
        });

        clearDesksBtn.addEventListener('click', () => {
            for (let row of currentLayout.grid) {
                for (let i = 0; i < row.length; i++) {
                    if (row[i]) { currentLayout.unplaced.push(row[i]); row[i] = ''; }
                }
            }
            saveLayout();
            renderGrid();
            renderUnplaced();
        });

        applyGridBtn.addEventListener('click', () => {
            const newRows = parseInt(rowCountInput.value);
            const newCols = parseInt(colCountInput.value);
            if (newRows < 1 || newCols < 1) return;
            currentLayout.rows = newRows;
            currentLayout.cols = newCols;
            while (currentLayout.grid.length < newRows) currentLayout.grid.push(new Array(newCols).fill(''));
            for (let row of currentLayout.grid) { while (row.length < newCols) row.push(''); }
            saveLayout();
            renderGrid();
        });

        classSelect.addEventListener('change', (e) => loadClass(e.target.value));

        themeButtons.forEach(btn => btn.addEventListener('click', () => { document.body.dataset.theme = btn.dataset.theme; }));

        // Fullscreen toggle
        fullscreenBtn.addEventListener('click', () => {
            const classroom = document.getElementById('classroom');
            if (!document.fullscreenElement) {
                classroom.requestFullscreen().catch(err => {
                    console.error('Fullscreen error:', err);
                });
            } else {
                document.exitFullscreen();
            }
        });

        // Update grid columns on fullscreen change
        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) {
                seatingGrid.style.gridTemplateColumns = `repeat(${currentLayout.cols}, 160px)`;
            } else {
                seatingGrid.style.gridTemplateColumns = `repeat(${currentLayout.cols}, clamp(90px, 10vw, 150px))`;
            }
        });

        exportBtn.addEventListener('click', async () => {
            const classroom = document.getElementById('classroom');
            if (typeof html2canvas === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                document.head.appendChild(script);
                await new Promise(resolve => script.onload = resolve);
            }
            try {
                const canvas = await html2canvas(classroom, {
                    backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-primary'),
                    scale: 2,
                    useCORS: true
                });
                const link = document.createElement('a');
                link.download = `klassrumsplacering_${currentLayout.name}_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (err) {
                console.error('Export failed:', err);
                alert('Exporteringen misslyckades. F√∂rs√∂k igen.');
            }
        });

        function setupEventListeners() {
            window.addEventListener('click', (e) => { if (e.target.classList.contains('modal')) closeModals(); });
            window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModals(); });
        }

        // === B√§nkv√§ljare Integration (VEP-Enhanced) ===
        let bankvalActive = false;
        let bankvalMode = 'fair';
        let bankvalMaxStarsVal = 3;
        let bankvalStudentData = {};
        let bankvalSelectedName = null;
        let bankvalHistory = [];  // VEP #5
        let bankvalLastPick = null; // VEP #6

        function loadBankvalState() {
            const saved = localStorage.getItem('bankval_state');
            if (saved) {
                const state = JSON.parse(saved);
                bankvalMode = state.mode || 'fair';
                bankvalMaxStarsVal = state.maxStars || 3;
                bankvalStudentData = state.studentData || {};
                bankvalHistory = state.history || [];
            }
            document.getElementById('bankvalMaxStars').value = bankvalMaxStarsVal;
            document.querySelectorAll('.bv-mode-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.mode === bankvalMode);
            });
            renderBankvalHistory();
        }

        function saveBankvalState() {
            localStorage.setItem('bankval_state', JSON.stringify({
                mode: bankvalMode,
                maxStars: bankvalMaxStarsVal,
                studentData: bankvalStudentData,
                history: bankvalHistory
            }));
        }

        function getPlacedStudents() {
            const students = [];
            if (!currentLayout) return students;
            for (let row = 0; row < currentLayout.rows; row++) {
                for (let col = 0; col < currentLayout.cols; col++) {
                    const seatKey = `${row}-${col}`;
                    if (currentLayout.removedSeats && currentLayout.removedSeats.includes(seatKey)) continue;
                    const name = currentLayout.grid[row]?.[col];
                    if (name && name.trim()) {
                        students.push({ name: name.trim(), row, col });
                    }
                }
            }
            return students;
        }

        function getStudentStars(name) {
            if (!bankvalStudentData[currentClass]) bankvalStudentData[currentClass] = {};
            if (!bankvalStudentData[currentClass][name]) bankvalStudentData[currentClass][name] = { stars: 0 };
            return bankvalStudentData[currentClass][name].stars;
        }

        function addStudentStar(name) {
            if (!bankvalStudentData[currentClass]) bankvalStudentData[currentClass] = {};
            if (!bankvalStudentData[currentClass][name]) bankvalStudentData[currentClass][name] = { stars: 0 };
            bankvalStudentData[currentClass][name].stars++;
        }

        // VEP #1: Visa klassnamn
        function updateBankvalClassName() {
            const className = classData[currentClass]?.name || currentClass;
            document.getElementById('bankvalClassName').textContent = className;
        }

        function toggleBankval() {
            bankvalActive = !bankvalActive;
            const overlay = document.getElementById('bankvalOverlay');
            const toggleBtn = document.getElementById('bankvalToggle');
            if (bankvalActive) {
                overlay.classList.add('active');
                toggleBtn.classList.add('active');
                loadBankvalState();
                updateBankvalClassName();
                renderBankvalGrid();
                updateBankvalStats();
            } else {
                overlay.classList.remove('active');
                toggleBtn.classList.remove('active');
            }
        }

        function renderBankvalGrid() {
            const grid = document.getElementById('bankvalGrid');
            grid.innerHTML = '';
            grid.style.gridTemplateColumns = `repeat(${currentLayout.cols}, clamp(70px, 7vw, 110px))`;

            for (let row = 0; row < currentLayout.rows; row++) {
                for (let col = 0; col < currentLayout.cols; col++) {
                    const seatKey = `${row}-${col}`;
                    const isRemoved = currentLayout.removedSeats && currentLayout.removedSeats.includes(seatKey);
                    const cell = document.createElement('div');
                    cell.className = 'bv-seat';
                    cell.dataset.row = row;
                    cell.dataset.col = col;

                    if (isRemoved) {
                        cell.classList.add('removed');
                        grid.appendChild(cell);
                        continue;
                    }

                    const name = currentLayout.grid[row]?.[col] || '';
                    if (name && name.trim()) {
                        const stars = getStudentStars(name.trim());
                        const isMaxed = stars >= bankvalMaxStarsVal;
                        const isSelected = bankvalSelectedName === name.trim();
                        if (isMaxed) cell.classList.add('maxed');
                        if (isSelected) cell.classList.add('selected');
                        cell.innerHTML = `<span class="bv-name">${name.trim()}</span><span class="bv-stars">${'‚òÖ'.repeat(stars)}</span>`;
                    } else {
                        cell.classList.add('empty');
                    }
                    grid.appendChild(cell);
                }
            }
        }

        function updateBankvalStats() {
            const students = getPlacedStudents();
            let available = 0, maxed = 0, totalStars = 0;
            students.forEach(s => {
                const stars = getStudentStars(s.name);
                if (stars >= bankvalMaxStarsVal) maxed++;
                else available++;
                totalStars += stars;
            });
            document.getElementById('bvStatAvailable').textContent = available;
            document.getElementById('bvStatMaxed').textContent = maxed;
            document.getElementById('bvStatTotal').textContent = totalStars;
        }

        function selectBankvalStudent() {
            const students = getPlacedStudents();
            const available = students.filter(s => getStudentStars(s.name) < bankvalMaxStarsVal);
            if (available.length === 0) return null;

            let selected;
            switch (bankvalMode) {
                case 'fair':
                    const minStars = Math.min(...available.map(s => getStudentStars(s.name)));
                    const eligible = available.filter(s => getStudentStars(s.name) === minStars);
                    selected = eligible[Math.floor(Math.random() * eligible.length)];
                    break;
                case 'weighted':
                    const maxFound = Math.max(...available.map(s => getStudentStars(s.name)));
                    const weights = available.map(s => maxFound - getStudentStars(s.name) + 1);
                    const totalWeight = weights.reduce((a, b) => a + b, 0);
                    let rand = Math.random() * totalWeight;
                    let cumulative = 0;
                    for (let i = 0; i < available.length; i++) {
                        cumulative += weights[i];
                        if (rand <= cumulative) { selected = available[i]; break; }
                    }
                    if (!selected) selected = available[0];
                    break;
                case 'random':
                default:
                    selected = available[Math.floor(Math.random() * available.length)];
            }
            return selected;
        }

        // VEP #5: Historik
        function renderBankvalHistory() {
            const container = document.getElementById('bankvalHistory');
            const list = document.getElementById('bankvalHistoryList');
            const classHistory = bankvalHistory.filter(h => h.cls === currentClass);
            if (classHistory.length === 0) {
                container.style.display = 'none';
                return;
            }
            container.style.display = 'block';
            list.innerHTML = '';
            classHistory.slice(-5).reverse().forEach(h => {
                const item = document.createElement('span');
                item.className = 'bv-history-item';
                item.textContent = h.name;
                list.appendChild(item);
            });
        }

        // VEP #9: Konfetti
        function spawnConfetti() {
            const colors = ['#6366f1', '#a855f7', '#f59e0b', '#10b981', '#ef4444', '#3b82f6'];
            const display = document.getElementById('bankvalDisplay');
            const rect = display.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            for (let i = 0; i < 25; i++) {
                const particle = document.createElement('div');
                particle.className = 'bv-confetti';
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.left = `${cx + (Math.random() - 0.5) * 200}px`;
                particle.style.top = `${cy + (Math.random() - 0.5) * 60}px`;
                particle.style.width = `${6 + Math.random() * 8}px`;
                particle.style.height = `${6 + Math.random() * 8}px`;
                particle.style.animationDuration = `${0.8 + Math.random() * 0.8}s`;
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 1600);
            }
        }

        async function animateBankvalSelection() {
            const students = getPlacedStudents();
            const available = students.filter(s => getStudentStars(s.name) < bankvalMaxStarsVal);
            if (available.length === 0) {
                showBankvalToast('Alla elever har n√•tt max stj√§rnor!');
                return;
            }

            const btn = document.getElementById('bankvalRandomBtn');
            btn.disabled = true;
            // VEP #3: Spinner-text p√• knappen
            const origBtnText = btn.textContent;
            btn.textContent = '‚è≥ Slumpar...';
            const display = document.getElementById('bankvalDisplay');
            display.classList.remove('hint', 'reveal', 'golden');

            // Phase: rapid cycling, highlighting many then fewer seats
            const totalSteps = 15;
            for (let i = 0; i < totalSteps; i++) {
                const highlightCount = Math.max(1, Math.floor(available.length * (1 - (i / totalSteps) * 0.9)));
                const shuffled = [...available].sort(() => Math.random() - 0.5);
                const highlighted = shuffled.slice(0, highlightCount);

                document.querySelectorAll('.bv-seat').forEach(el => el.classList.remove('spinning-preview'));
                highlighted.forEach(s => {
                    const seat = document.querySelector(`.bv-seat[data-row="${s.row}"][data-col="${s.col}"]`);
                    if (seat && !seat.classList.contains('maxed')) seat.classList.add('spinning-preview');
                });

                const randomStudent = highlighted[Math.floor(Math.random() * highlighted.length)];
                display.textContent = randomStudent.name;
                display.classList.add('spinning');

                const delay = 40 + (i * i * 1.2);
                await bankvalSleep(delay);
                display.classList.remove('spinning');
            }

            document.querySelectorAll('.bv-seat').forEach(el => el.classList.remove('spinning-preview'));

            const finalStudent = selectBankvalStudent();
            if (finalStudent) {
                bankvalSelectedName = finalStudent.name;
                bankvalLastPick = { name: finalStudent.name, cls: currentClass }; // VEP #6
                addStudentStar(finalStudent.name);

                // VEP #5: Historik
                bankvalHistory.push({ name: finalStudent.name, cls: currentClass, time: Date.now() });
                if (bankvalHistory.length > 50) bankvalHistory = bankvalHistory.slice(-50);

                display.textContent = finalStudent.name;
                const isMaxed = getStudentStars(finalStudent.name) >= bankvalMaxStarsVal;
                display.classList.toggle('golden', isMaxed);

                // VEP #4: Reveal-animation
                display.classList.add('reveal');
                setTimeout(() => display.classList.remove('reveal'), 600);

                // VEP #9: Konfetti
                spawnConfetti();

                renderBankvalGrid();
                updateBankvalStats();
                renderBankvalHistory();
                saveBankvalState();

                // VEP #6: Aktivera √•ngra-knapp
                document.getElementById('bankvalUndo').disabled = false;
            }

            btn.textContent = origBtnText;
            btn.disabled = false;
        }

        // VEP #6: √Öngra senaste
        function undoLastPick() {
            if (!bankvalLastPick) return;
            const { name, cls } = bankvalLastPick;
            if (bankvalStudentData[cls] && bankvalStudentData[cls][name]) {
                bankvalStudentData[cls][name].stars = Math.max(0, bankvalStudentData[cls][name].stars - 1);
            }
            // Ta bort fr√•n historik
            const idx = bankvalHistory.findLastIndex(h => h.name === name && h.cls === cls);
            if (idx > -1) bankvalHistory.splice(idx, 1);
            bankvalLastPick = null;
            bankvalSelectedName = null;
            document.getElementById('bankvalUndo').disabled = true;
            const display = document.getElementById('bankvalDisplay');
            display.textContent = 'Tryck mellanslag eller klicka nedan ‚¨á';
            display.classList.add('hint');
            display.classList.remove('golden');
            renderBankvalGrid();
            updateBankvalStats();
            renderBankvalHistory();
            saveBankvalState();
            showBankvalToast('Senaste valet √•ngrat!');
        }

        function bankvalSleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

        function showBankvalToast(message) {
            const toast = document.getElementById('bankvalToast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function resetBankvalStars() {
            if (confirm('Nollst√§ll alla stj√§rnor f√∂r denna klass?')) {
                bankvalStudentData[currentClass] = {};
                bankvalSelectedName = null;
                bankvalLastPick = null;
                bankvalHistory = bankvalHistory.filter(h => h.cls !== currentClass);
                const display = document.getElementById('bankvalDisplay');
                display.textContent = 'Tryck mellanslag eller klicka nedan ‚¨á';
                display.classList.add('hint');
                display.classList.remove('golden');
                document.getElementById('bankvalUndo').disabled = true;
                renderBankvalGrid();
                updateBankvalStats();
                renderBankvalHistory();
                saveBankvalState();
                showBankvalToast('Stj√§rnor nollst√§llda!');
            }
        }

        function setupBankvalListeners() {
            document.getElementById('bankvalToggle').addEventListener('click', toggleBankval);
            document.getElementById('bankvalRandomBtn').addEventListener('click', animateBankvalSelection);
            document.getElementById('bankvalClose').addEventListener('click', toggleBankval);
            document.getElementById('bankvalResetStars').addEventListener('click', resetBankvalStars);
            document.getElementById('bankvalUndo').addEventListener('click', undoLastPick); // VEP #6

            document.querySelectorAll('.bv-mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.bv-mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    bankvalMode = btn.dataset.mode;
                    saveBankvalState();
                });
            });

            document.getElementById('bankvalMaxStars').addEventListener('change', (e) => {
                bankvalMaxStarsVal = parseInt(e.target.value) || 3;
                renderBankvalGrid();
                updateBankvalStats();
                saveBankvalState();
            });

            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space' && bankvalActive && !document.getElementById('bankvalRandomBtn').disabled) {
                    e.preventDefault();
                    animateBankvalSelection();
                }
            });

            // Refresh bankval grid when class changes
            classSelect.addEventListener('change', () => {
                if (bankvalActive) {
                    setTimeout(() => {
                        updateBankvalClassName();
                        renderBankvalGrid();
                        updateBankvalStats();
                        renderBankvalHistory();
                        bankvalSelectedName = null;
                        bankvalLastPick = null;
                        document.getElementById('bankvalUndo').disabled = true;
                        const display = document.getElementById('bankvalDisplay');
                        display.textContent = 'Tryck mellanslag eller klicka nedan ‚¨á';
                        display.classList.add('hint');
                        display.classList.remove('golden');
                    }, 150);
                }
            });

            // Close on Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && bankvalActive) {
                    toggleBankval();
                }
            });
        }

        setupBankvalListeners();
        loadBankvalState();

        init();
    </script>
</body>

</html>